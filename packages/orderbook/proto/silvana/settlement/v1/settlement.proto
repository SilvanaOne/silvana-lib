syntax = "proto3";

package silvana.settlement.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";

option go_package = "github.com/SilvanaOne/canton-agent/proto;settlement";

// ============================================================================
// Enumerations
// ============================================================================

// DVP settlement stage enumeration
enum SettlementStage {
  SETTLEMENT_STAGE_UNSPECIFIED = 0;
  SETTLEMENT_STAGE_PROPOSAL_RECEIVED = 1;
  SETTLEMENT_STAGE_PRECONFIRMATION_PENDING = 2;
  SETTLEMENT_STAGE_PRECONFIRMED = 3;
  SETTLEMENT_STAGE_DVP_PROPOSAL_CREATING = 4;
  SETTLEMENT_STAGE_DVP_PROPOSAL_CREATED = 5;
  SETTLEMENT_STAGE_DVP_ACCEPTING = 6;
  SETTLEMENT_STAGE_DVP_ACCEPTED = 7;
  SETTLEMENT_STAGE_ALLOCATING = 8;
  SETTLEMENT_STAGE_ALLOCATED = 9;
  SETTLEMENT_STAGE_SETTLING = 10;
  SETTLEMENT_STAGE_SETTLED = 11;
  SETTLEMENT_STAGE_FAILED = 12;
  SETTLEMENT_STAGE_CANCELLED = 13;
}

// Preconfirmation response type
enum PreconfirmationResponse {
  PRECONFIRMATION_RESPONSE_UNSPECIFIED = 0;
  PRECONFIRMATION_RESPONSE_ACCEPT = 1;
  PRECONFIRMATION_RESPONSE_REJECT = 2;
}

// Party role in settlement
enum PartyRole {
  PARTY_ROLE_UNSPECIFIED = 0;
  PARTY_ROLE_BUYER = 1;
  PARTY_ROLE_SELLER = 2;
  PARTY_ROLE_OPERATOR = 3;
}

// Transaction type for history tracking
enum TransactionType {
  TRANSACTION_TYPE_UNSPECIFIED = 0;
  TRANSACTION_TYPE_USER_SERVICE_REQUEST = 1;
  TRANSACTION_TYPE_USER_SERVICE_REQUEST_ACCEPT = 2;
  TRANSACTION_TYPE_USER_SERVICE_CANCEL = 3;
  TRANSACTION_TYPE_DVP_PROPOSE = 4;
  TRANSACTION_TYPE_DVP_ACCEPT = 5;
  TRANSACTION_TYPE_DVP_CANCEL = 6;
  TRANSACTION_TYPE_DVP_SETTLE = 7;
  TRANSACTION_TYPE_ALLOCATE = 8;
  TRANSACTION_TYPE_ALLOCATE_CANCEL = 9;
  TRANSACTION_TYPE_FEE_TRANSFER = 10;
  TRANSACTION_TYPE_MERGE = 11;
  TRANSACTION_TYPE_UNLOCK = 12;
  TRANSACTION_TYPE_OTHER = 13;
}

// Sender type for transaction history
enum SenderType {
  SENDER_TYPE_UNSPECIFIED = 0;
  SENDER_TYPE_OPERATOR = 1;
  SENDER_TYPE_USER = 2;
  SENDER_TYPE_BUYER = 3;
  SENDER_TYPE_SELLER = 4;
}

// Transaction result
enum TransactionResult {
  TRANSACTION_RESULT_UNSPECIFIED = 0;
  TRANSACTION_RESULT_PENDING = 1;
  TRANSACTION_RESULT_SUCCESS = 2;
  TRANSACTION_RESULT_FAILED = 3;
}

// ============================================================================
// Settlement Proposal History Event Types (DVP Flow)
// ============================================================================

// Event types for settlement proposal history (all 11 DVP transactions + contract lifecycle)
enum SettlementEventType {
  SETTLEMENT_EVENT_TYPE_UNSPECIFIED = 0;

  // Step 1: DVP Processing Fee (buyer pays)
  SETTLEMENT_EVENT_TYPE_DVP_PROCESSING_FEE_BUYER_SUBMITTED = 1;
  SETTLEMENT_EVENT_TYPE_DVP_PROCESSING_FEE_BUYER_COMPLETED = 2;
  SETTLEMENT_EVENT_TYPE_DVP_PROCESSING_FEE_BUYER_RECEIVED = 3;

  // Step 2: DVP Request (buyer creates DvpProposal)
  SETTLEMENT_EVENT_TYPE_DVP_REQUEST_SUBMITTED = 4;
  SETTLEMENT_EVENT_TYPE_DVP_REQUEST_COMPLETED = 5;
  SETTLEMENT_EVENT_TYPE_DVP_REQUEST_WITNESSED = 6;
  SETTLEMENT_EVENT_TYPE_DVP_REQUEST_REJECTED = 7;
  SETTLEMENT_EVENT_TYPE_DVP_REQUEST_CANCELLED = 8;

  // Step 3: DVP Processing Fee (seller pays)
  SETTLEMENT_EVENT_TYPE_DVP_PROCESSING_FEE_SELLER_SUBMITTED = 9;
  SETTLEMENT_EVENT_TYPE_DVP_PROCESSING_FEE_SELLER_COMPLETED = 10;
  SETTLEMENT_EVENT_TYPE_DVP_PROCESSING_FEE_SELLER_RECEIVED = 11;

  // Step 4: Accept DVP (seller accepts, creates Dvp contract)
  SETTLEMENT_EVENT_TYPE_DVP_ACCEPT_SUBMITTED = 12;
  SETTLEMENT_EVENT_TYPE_DVP_ACCEPT_COMPLETED = 13;
  SETTLEMENT_EVENT_TYPE_DVP_ACCEPTED_WITNESSED = 14;
  SETTLEMENT_EVENT_TYPE_DVP_REJECTED = 15;
  SETTLEMENT_EVENT_TYPE_DVP_WITHDRAWN = 16;
  SETTLEMENT_EVENT_TYPE_DVP_CANCELLED = 17;

  // Step 5: Allocation Processing Fee (buyer pays)
  SETTLEMENT_EVENT_TYPE_ALLOCATION_PROCESSING_FEE_BUYER_SUBMITTED = 18;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_PROCESSING_FEE_BUYER_COMPLETED = 19;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_PROCESSING_FEE_BUYER_RECEIVED = 20;

  // Step 6: Allocate CC (buyer allocates base instrument)
  SETTLEMENT_EVENT_TYPE_ALLOCATION_BUYER_SUBMITTED = 21;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_BUYER_COMPLETED = 22;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_BUYER_WITNESSED = 23;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_BUYER_WITHDRAWN = 24;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_BUYER_CANCELLED = 25;

  // Step 7: Allocation Processing Fee (seller pays)
  SETTLEMENT_EVENT_TYPE_ALLOCATION_PROCESSING_FEE_SELLER_SUBMITTED = 26;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_PROCESSING_FEE_SELLER_COMPLETED = 27;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_PROCESSING_FEE_SELLER_RECEIVED = 28;

  // Step 8: Allocate USDC (seller allocates quote instrument)
  SETTLEMENT_EVENT_TYPE_ALLOCATION_SELLER_SUBMITTED = 29;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_SELLER_COMPLETED = 30;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_SELLER_WITNESSED = 31;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_SELLER_WITHDRAWN = 32;
  SETTLEMENT_EVENT_TYPE_ALLOCATION_SELLER_CANCELLED = 33;

  // Step 9: DVP Settlement (operator executes atomic swap)
  SETTLEMENT_EVENT_TYPE_SETTLEMENT_SUBMITTED = 34;
  SETTLEMENT_EVENT_TYPE_SETTLEMENT_COMPLETED = 35;
  SETTLEMENT_EVENT_TYPE_SETTLEMENT_WITNESSED = 36;

  // Step 10: Traffic Compensation to Buyer
  SETTLEMENT_EVENT_TYPE_TRAFFIC_COMPENSATION_BUYER_SUBMITTED = 37;
  SETTLEMENT_EVENT_TYPE_TRAFFIC_COMPENSATION_BUYER_COMPLETED = 38;

  // Step 11: Traffic Compensation to Seller
  SETTLEMENT_EVENT_TYPE_TRAFFIC_COMPENSATION_SELLER_SUBMITTED = 39;
  SETTLEMENT_EVENT_TYPE_TRAFFIC_COMPENSATION_SELLER_COMPLETED = 40;

  // Preconfirmation (optional off-chain flow)
  SETTLEMENT_EVENT_TYPE_PRECONFIRMATION_REQUESTED = 41;
  SETTLEMENT_EVENT_TYPE_PRECONFIRMATION_BUYER = 42;
  SETTLEMENT_EVENT_TYPE_PRECONFIRMATION_SELLER = 43;
  SETTLEMENT_EVENT_TYPE_PRECONFIRMATION_CANCELLED = 44;

  // Timeout (for expired proposals)
  SETTLEMENT_EVENT_TYPE_TIMEOUT = 45;
}

// Role of the party recording the event
enum RecordedByRole {
  RECORDED_BY_ROLE_UNSPECIFIED = 0;
  RECORDED_BY_ROLE_BUYER = 1;
  RECORDED_BY_ROLE_SELLER = 2;
  RECORDED_BY_ROLE_OPERATOR = 3;
  RECORDED_BY_ROLE_SYSTEM = 4;
}

// Result of a settlement event
enum SettlementEventResult {
  SETTLEMENT_EVENT_RESULT_UNSPECIFIED = 0;
  SETTLEMENT_EVENT_RESULT_PENDING = 1;
  SETTLEMENT_EVENT_RESULT_SUCCESS = 2;
  SETTLEMENT_EVENT_RESULT_FAILED = 3;
  SETTLEMENT_EVENT_RESULT_TIMEOUT = 4;
}

// ============================================================================
// Core Messages for Settlement Flow
// ============================================================================

// Canton node authentication (using Canton party JWT)
message CantonNodeAuth {
  string party_id = 1; // Canton party identifier
  string jwt_token = 2; // JWT for Canton ledger API
  string node_instance = 3; // Node instance identifier
  google.protobuf.Timestamp connected_at = 4;
}

// External account authentication (using Ed25519 signed JWT)
// For external parties that sign JWTs with their own private keys
// Public key is verified against party_id fingerprint:
//   fingerprint = SHA256(0x0000000C || public_key_bytes)
//   party_id format: "identifier::1220{fingerprint}"
message ExternalAuth {
  string jwt = 1;              // JWT signed with external account's Ed25519 private key
  string party_id = 2;         // Canton party ID of the external account
  string public_key = 3;       // Ed25519 public key (hex) - verified against party_id fingerprint
}

// Instrument details for settlement
message SettlementInstrument {
  string instrument_id = 1;
  string symbol = 2;
  string registry = 3; // Canton registry party ID
  string quantity = 4; // DECIMAL(38,10) as string
  optional google.protobuf.Struct metadata = 5;
}

// Settlement proposal from orderbook
message SettlementProposalMessage {
  string proposal_id = 1; // UUID v7 - single ID used everywhere
  string settlement_id = 2; // Same as proposal_id for DVP operations
  string market_id = 3;
  string buyer_party = 4; // Canton party ID
  string seller_party = 5; // Canton party ID
  SettlementInstrument base_instrument = 6;
  SettlementInstrument quote_instrument = 7;
  string settlement_price = 8; // DECIMAL(38,10) as string
  google.protobuf.Timestamp allocate_before = 9; // Deadline for allocation
  google.protobuf.Timestamp settle_before = 10; // Deadline for settlement
  optional google.protobuf.Struct metadata = 11;
  google.protobuf.Timestamp created_at = 12;
  // Processing fees (DECIMAL as string)
  string dvp_processing_fee_buyer = 13;
  string dvp_processing_fee_seller = 14;
  string allocation_processing_fee_buyer = 15;
  string allocation_processing_fee_seller = 16;
}

// Preconfirmation request
message PreconfirmationRequest {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  SettlementProposalMessage proposal = 3;
  string requesting_party = 4; // Who is requesting confirmation
  google.protobuf.Timestamp respond_by = 5; // Response deadline
  optional google.protobuf.Struct terms = 6; // Additional terms to confirm
}

// Preconfirmation decision from Canton node
message PreconfirmationDecision {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  PreconfirmationResponse response = 3;
  optional string rejection_reason = 4;
  optional google.protobuf.Struct conditions = 5; // Additional conditions if accepting
  string signed_by = 6; // Canton party ID
  google.protobuf.Timestamp decided_at = 7;
}

// DVP contract creation notification
message DvpContractCreated {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  string dvp_proposal_cid = 3; // DvpProposal contract ID
  string dvp_proposal_update_id = 4; // Canton ledger update ID
  string proposer_party = 5; // Who created the proposal
  string counterparty = 6; // Who needs to accept
  google.protobuf.Timestamp created_at = 7;
}

// DVP acceptance notification
message DvpContractAccepted {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  string dvp_cid = 3; // Dvp contract ID
  string dvp_update_id = 4; // Canton ledger update ID
  string accepted_by = 5; // Canton party ID
  google.protobuf.Timestamp accepted_at = 6;
}

// Allocation status update
message AllocationStatus {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  PartyRole party_role = 3;
  string party_id = 4;
  string allocation_cid = 5; // Allocation contract ID
  string allocation_update_id = 6; // Canton ledger update ID
  string instrument_id = 7;
  string quantity = 8; // DECIMAL(38,10) as string
  bool is_allocated = 9;
  optional string error_message = 10;
  google.protobuf.Timestamp allocated_at = 11;
}

// Settlement execution status
message SettlementExecutionStatus {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  string dvp_cid = 3;
  string settled_dvp_cid = 4; // SettledDvp contract ID
  string settlement_update_id = 5; // Canton ledger update ID
  string settlement_completion_offset = 6; // Canton ledger offset
  bool is_successful = 7;
  optional string error_message = 8;
  google.protobuf.Timestamp settled_at = 9;
}

// User service contract info (for DVP operations)
message UserServiceInfo {
  string party_id = 1;
  string user_service_cid = 2; // UserService contract ID
  string operator_config_cid = 3; // OperatorConfiguration contract ID
  google.protobuf.Timestamp created_at = 4;
}

// ============================================================================
// Bidirectional Streaming Messages
// ============================================================================

// Initial handshake from Canton node to server
message SettlementHandshake {
  CantonNodeAuth auth = 1;
  repeated string party_ids = 2; // Parties this node represents
  repeated UserServiceInfo user_services = 3; // UserService contracts for DVP
  string operator_party = 4; // Settlement operator party ID
  optional google.protobuf.Struct capabilities = 5; // Node capabilities
}

// Handshake acknowledgment from server
message HandshakeAck {
  bool accepted = 1;
  optional string rejection_reason = 2;
  string session_id = 3;
  repeated string supported_instruments = 4; // Instruments this node can settle
  google.protobuf.Timestamp server_time = 5;
}

// Heartbeat message (bidirectional)
message Heartbeat {
  string session_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  uint64 sequence_number = 3;
}

// Liquidity provider ping message (Canton node to server)
// Sent periodically by settlement agents to indicate LP is active
message LiquidityProviderPing {
  string liquidity_provider_name = 1;  // LP name to update activity for
  google.protobuf.Timestamp timestamp = 2;
}

// Liquidity provider pong message (server to Canton node)
// Acknowledgment of ping receipt
message LiquidityProviderPong {
  string liquidity_provider_name = 1;  // LP name that was updated
  bool success = 2;                     // Whether the update succeeded
  optional string error_message = 3;    // Error details if failed
  google.protobuf.Timestamp server_time = 4;
}

// Stream message from server to Canton node
message ServerToCantonMessage {
  string session_id = 1;
  uint64 sequence_number = 2;

  oneof message {
    HandshakeAck handshake_ack = 3;
    Heartbeat heartbeat = 4;
    SettlementProposalMessage proposal = 5;
    PreconfirmationRequest preconfirmation_request = 6;
    DvpContractCreated dvp_created = 7;
    DvpContractAccepted dvp_accepted = 8;
    AllocationStatus allocation_status = 9;
    SettlementExecutionStatus settlement_status = 10;
    SettlementCommand command = 11;
    SettlementQuery query = 12;
    LiquidityProviderPong lp_pong = 14;  // Pong acknowledgment for LP activity ping
  }

  google.protobuf.Timestamp sent_at = 13;
}

// Stream message from Canton node to server
message CantonToServerMessage {
  string session_id = 1;
  uint64 sequence_number = 2;

  oneof message {
    SettlementHandshake handshake = 3;
    Heartbeat heartbeat = 4;
    PreconfirmationDecision preconfirmation = 5;
    DvpCreationReport dvp_creation = 6;
    DvpAcceptanceReport dvp_acceptance = 7;
    AllocationReport allocation = 8;
    SettlementReport settlement = 9;
    SettlementResponse response = 10;
    ErrorReport error = 11;
    StatusUpdate status = 12;
    LiquidityProviderPing lp_ping = 14;  // Ping from settlement agent for LP activity
  }

  google.protobuf.Timestamp sent_at = 13;
}

// ============================================================================
// Canton Node Reports (sent upstream)
// ============================================================================

// Report DVP proposal creation
message DvpCreationReport {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  bool success = 3;
  optional string dvp_proposal_cid = 4;
  optional string dvp_proposal_update_id = 5;
  optional string error_message = 6;
  google.protobuf.Timestamp created_at = 7;
}

// Report DVP acceptance
message DvpAcceptanceReport {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  bool success = 3;
  optional string dvp_cid = 4;
  optional string dvp_update_id = 5;
  optional string error_message = 6;
  google.protobuf.Timestamp accepted_at = 7;
}

// Report allocation completion
message AllocationReport {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  PartyRole party_role = 3;
  bool success = 4;
  optional string allocation_cid = 5;
  optional string allocation_update_id = 6;
  repeated string holding_cids = 7; // Holding contracts used
  optional string error_message = 8;
  google.protobuf.Timestamp allocated_at = 9;
}

// Report settlement completion
message SettlementReport {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  bool success = 3;
  optional string settled_dvp_cid = 4;
  optional string settlement_update_id = 5;
  optional string settlement_completion_offset = 6;
  repeated string archived_cids = 7; // Contracts archived during settlement
  optional string error_message = 8;
  google.protobuf.Timestamp settled_at = 9;
}

// Error report
message ErrorReport {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  SettlementStage stage = 3;
  string error_code = 4;
  string error_message = 5;
  optional google.protobuf.Struct details = 6;
  google.protobuf.Timestamp occurred_at = 7;
}

// Status update
message StatusUpdate {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;
  SettlementStage current_stage = 3;
  optional string message = 4;
  optional google.protobuf.Struct metrics = 5; // Performance metrics
  google.protobuf.Timestamp updated_at = 6;
}

// ============================================================================
// Commands and Queries (server to Canton node)
// ============================================================================

// Command to Canton node
message SettlementCommand {
  enum CommandType {
    COMMAND_TYPE_UNSPECIFIED = 0;
    COMMAND_TYPE_CREATE_DVP_PROPOSAL = 1;
    COMMAND_TYPE_ACCEPT_DVP = 2;
    COMMAND_TYPE_ALLOCATE = 3;
    COMMAND_TYPE_SETTLE = 4;
    COMMAND_TYPE_CANCEL = 5;
    COMMAND_TYPE_RETRY = 6;
  }

  CommandType command_type = 1;
  string proposal_id = 2;  // UUID v7
  string settlement_id = 3;
  optional google.protobuf.Struct parameters = 4;
  google.protobuf.Timestamp execute_by = 5; // Deadline
}

// Query to Canton node
message SettlementQuery {
  enum QueryType {
    QUERY_TYPE_UNSPECIFIED = 0;
    QUERY_TYPE_GET_HOLDINGS = 1;
    QUERY_TYPE_GET_USER_SERVICE = 2;
    QUERY_TYPE_GET_CONTRACT = 3;
    QUERY_TYPE_GET_ALLOCATION_STATUS = 4;
    QUERY_TYPE_CHECK_LIQUIDITY = 5;
  }

  QueryType query_type = 1;
  optional string party_id = 2;
  optional string contract_id = 3;
  optional string instrument_id = 4;
  optional google.protobuf.Struct parameters = 5;
}

// Response to command or query
message SettlementResponse {
  bool success = 1;
  optional string message = 2;
  optional google.protobuf.Struct data = 3;
  google.protobuf.Timestamp responded_at = 4;
}

// ============================================================================
// Service Definition
// ============================================================================

service SettlementService {
  // Bidirectional streaming for settlement flow
  // Canton node initiates connection and maintains stream
  rpc SettlementStream(stream CantonToServerMessage) returns (stream ServerToCantonMessage);

  // Optional unary RPCs for specific operations

  // Get pending proposals for a party
  rpc GetPendingProposals(GetPendingProposalsRequest) returns (GetPendingProposalsResponse);

  // Query settlement status
  rpc GetSettlementStatus(GetSettlementStatusRequest) returns (GetSettlementStatusResponse);

  // Manual preconfirmation (if not using stream)
  rpc SubmitPreconfirmation(SubmitPreconfirmationRequest) returns (google.protobuf.Empty);

  // Save a disclosed contract (buyer/seller saves during allocation)
  rpc SaveDisclosedContract(SaveDisclosedContractRequest) returns (SaveDisclosedContractResponse);

  // Get disclosed contracts (operator gets all, buyer/seller gets own)
  rpc GetDisclosedContracts(GetDisclosedContractsRequest) returns (GetDisclosedContractsResponse);

  // Record a completed settlement (updates proposal AND creates settlements table record)
  rpc RecordSettlement(RecordSettlementRequest) returns (RecordSettlementResponse);

  // Record a transaction in history
  rpc RecordTransaction(RecordTransactionRequest) returns (RecordTransactionResponse);

  // Get transaction history
  rpc GetTransactionHistory(GetTransactionHistoryRequest) returns (GetTransactionHistoryResponse);

  // Settlement proposal history (append-only event log)
  // Record a settlement event (any party can record for their settlements)
  rpc RecordSettlementEvent(RecordSettlementEventRequest) returns (RecordSettlementEventResponse);

  // Get settlement history for a proposal
  rpc GetSettlementHistory(GetSettlementHistoryRequest) returns (GetSettlementHistoryResponse);

  // Update proposal status (operator only: pending → settled/cancelled/failed)
  rpc UpdateProposalStatus(UpdateProposalStatusRequest) returns (UpdateProposalStatusResponse);

  // Get settlement proposal by ID (for external parties to fetch proposal details)
  rpc GetSettlementProposalById(GetSettlementProposalByIdRequest) returns (GetSettlementProposalByIdResponse);
}

// ============================================================================
// Unary RPC Messages (optional, if not using streaming)
// ============================================================================

message GetPendingProposalsRequest {
  CantonNodeAuth auth = 1;
  string party_id = 2;
  optional uint32 limit = 3;
}

message GetPendingProposalsResponse {
  repeated SettlementProposalMessage proposals = 1;
  uint32 total = 2;
}

message GetSettlementStatusRequest {
  CantonNodeAuth auth = 1;
  string settlement_id = 2;
}

// Status of a single step in the DVP flow
enum DvpStepStatusEnum {
  DVP_STEP_STATUS_UNSPECIFIED = 0;
  DVP_STEP_STATUS_PENDING = 1;      // Not started
  DVP_STEP_STATUS_SUBMITTED = 2;    // Transaction submitted
  DVP_STEP_STATUS_COMPLETED = 3;    // Transaction completed
  DVP_STEP_STATUS_CONFIRMED = 4;    // Confirmed by operator (or witnessed on-chain)
  DVP_STEP_STATUS_FAILED = 5;       // Failed
  DVP_STEP_STATUS_REJECTED = 6;     // Rejected by counterparty
  DVP_STEP_STATUS_WITHDRAWN = 7;    // Withdrawn
  DVP_STEP_STATUS_CANCELLED = 8;    // Cancelled
  DVP_STEP_STATUS_TIMEOUT = 9;      // Timed out
}

// Status of a single step in the DVP flow with details
message DvpStepStatus {
  // Step name (e.g., "dvp_processing_fee_buyer", "dvp_request", etc.)
  string step_name = 1;

  // Current status
  DvpStepStatusEnum status = 2;

  // Contract ID (if created)
  optional string contract_id = 3;

  // Update ID (Canton ledger update)
  optional string update_id = 4;

  // Latest event timestamp
  optional google.protobuf.Timestamp updated_at = 5;

  // Error message (if failed)
  optional string error_message = 6;

  // Who confirmed this step (party ID)
  optional string confirmed_by = 7;

  // Role of who confirmed (buyer/seller/operator)
  optional RecordedByRole confirmed_by_role = 8;
}

// Enhanced GetSettlementStatusResponse with detailed DVP flow progress
message GetSettlementStatusResponse {
  string proposal_id = 1;  // UUID v7
  string settlement_id = 2;

  // Overall settlement stage
  SettlementStage stage = 3;

  // Overall error message (if failed)
  optional string error_message = 4;

  // Last updated timestamp
  google.protobuf.Timestamp updated_at = 5;

  // ============================================================================
  // Detailed DVP Step Statuses
  // Each step is analyzed from settlement_proposal_history events using priority:
  // 1. Operator confirmation (received/witnessed events)
  // 2. Buyer/Seller completed with update_id
  // 3. Submitted but not confirmed
  // 4. Failure/Rejection/Cancellation
  // ============================================================================

  // Fee payment steps
  DvpStepStatus dvp_processing_fee_buyer = 10;
  DvpStepStatus dvp_processing_fee_seller = 11;
  DvpStepStatus allocation_processing_fee_buyer = 12;
  DvpStepStatus allocation_processing_fee_seller = 13;

  // DVP contract steps
  DvpStepStatus dvp_request = 14;
  DvpStepStatus dvp_accept = 15;

  // Allocation steps
  DvpStepStatus allocation_buyer = 16;
  DvpStepStatus allocation_seller = 17;

  // Settlement step
  DvpStepStatus settlement = 18;

  // Traffic compensation steps
  DvpStepStatus traffic_compensation_buyer = 19;
  DvpStepStatus traffic_compensation_seller = 20;

  // Preconfirmation step (optional)
  DvpStepStatus preconfirmation = 21;
}

message SubmitPreconfirmationRequest {
  CantonNodeAuth auth = 1;
  PreconfirmationDecision decision = 2;
}

// ============================================================================
// Disclosed Contracts Messages
// ============================================================================

// A disclosed contract for settlement
// Buyers/sellers save these during allocation for cross-party visibility
message DisclosedContractMessage {
  string contract_id = 1;         // Canton contract ID
  string template_id = 2;         // Template identifier (e.g., "splice-amulet:Splice.Amulet:LockedAmulet")
  string created_event_blob = 3;  // Base64-encoded blob required for disclosures
  string synchronizer_id = 4;     // Canton synchronizer/domain ID
}

// Save disclosed contract request (buyer/seller saves their contracts during allocation)
message SaveDisclosedContractRequest {
  CantonNodeAuth auth = 1;
  string proposal_id = 2;  // UUID v7
  DisclosedContractMessage contract = 3;
  optional ExternalAuth external_auth = 10;  // Alternative auth for external parties
}

// Save disclosed contract response
message SaveDisclosedContractResponse {
  bool success = 1;
  string message = 2;
}

// Get disclosed contracts request
message GetDisclosedContractsRequest {
  CantonNodeAuth auth = 1;
  string proposal_id = 2;  // UUID v7
  optional string owner = 3;  // "buyer" or "seller", omit for all (operator only)
}

// Get disclosed contracts response
message GetDisclosedContractsResponse {
  repeated DisclosedContractMessage contracts = 1;
}

// ============================================================================
// Record Settlement Messages
// ============================================================================

// Record a completed settlement request
// Called by settlement operator after successful Dvp_Settle execution
message RecordSettlementRequest {
  CantonNodeAuth auth = 1;
  string proposal_id = 2;  // UUID v7
  string settled_dvp_cid = 3;              // SettledDvp contract ID from Canton
  string settlement_update_id = 4;          // Canton ledger update ID
  string settlement_completion_offset = 5;  // Canton ledger offset
  // Optional fields to correct DB state (on-chain is source of truth)
  optional string dvp_cid = 6;              // DVP contract ID (if missing in DB)
  optional string allocation_buyer_cid = 7;  // Buyer's allocation CID
  optional string allocation_seller_cid = 8; // Seller's allocation CID
}

// Record settlement response
message RecordSettlementResponse {
  bool success = 1;
  string message = 2;
  string settlement_id = 3;  // UUID v7 - The proposal_id used as settlement ID
}

// ============================================================================
// Transaction History Messages
// ============================================================================

// Record a transaction in history
message RecordTransactionRequest {
  CantonNodeAuth auth = 1;
  TransactionType tx_type = 2;
  string sender_party = 3;
  SenderType sender_type = 4;

  // Optional Canton IDs
  optional string update_id = 5;
  optional string submission_id = 6;
  optional string settlement_proposal_id = 7;

  // Transaction context
  optional string market_id = 8;
  optional string counterparty = 9;

  // Contract references
  optional string contract_id = 10;
  optional string choice_name = 11;

  // Financial data
  optional string amount = 12;  // DECIMAL(38,10) as string
  optional string rewards_amount = 13;
  optional uint64 rewards_round = 14;
  optional uint64 traffic_request = 15;
  optional uint64 traffic_response = 16;
  optional uint64 traffic_total = 17;
  optional uint64 activity_marker_created = 18;

  // Result
  TransactionResult result = 19;
  optional string error_message = 20;
  optional google.protobuf.Struct metadata = 21;
  optional google.protobuf.Struct update = 22;  // Additional update data from Canton

  // Daml template and choice info
  string daml_template_id = 23;     // Daml template ID (required)
  string daml_choice = 24;          // Daml choice name (required)
  optional google.protobuf.Struct daml_choices = 25; // Additional choice data as JSON

  // Alternative auth for external parties
  optional ExternalAuth external_auth = 30;
}

message RecordTransactionResponse {
  bool success = 1;
  string message = 2;
  uint64 transaction_id = 3;  // Auto-generated ID
}

// Get transaction history
message GetTransactionHistoryRequest {
  CantonNodeAuth auth = 1;
  optional string sender_party = 2;
  optional TransactionType tx_type = 3;
  optional string settlement_proposal_id = 4;
  optional TransactionResult result = 5;
  optional uint32 limit = 6;
  optional uint32 offset = 7;
}

message GetTransactionHistoryResponse {
  repeated TransactionHistoryEntry transactions = 1;
  uint32 total = 2;
}

message TransactionHistoryEntry {
  uint64 id = 1;
  TransactionType tx_type = 2;
  string sender_party = 3;
  SenderType sender_type = 4;
  optional string update_id = 5;
  optional string submission_id = 6;
  optional string settlement_proposal_id = 7;
  optional string market_id = 8;
  optional string counterparty = 9;
  optional string contract_id = 10;
  optional string choice_name = 11;
  optional string amount = 12;
  optional string rewards_amount = 13;
  optional uint64 rewards_round = 14;
  optional uint64 traffic_request = 15;
  optional uint64 traffic_response = 16;
  optional uint64 traffic_total = 17;
  optional uint64 activity_marker_created = 18;
  TransactionResult result = 19;
  optional string error_message = 20;
  optional google.protobuf.Struct metadata = 21;
  google.protobuf.Timestamp created_at = 22;
  optional google.protobuf.Struct update = 23;  // Additional update data from Canton

  // Daml template and choice info
  string daml_template_id = 24;     // Daml template ID
  string daml_choice = 25;          // Daml choice name
  optional google.protobuf.Struct daml_choices = 26; // Additional choice data
}

// ============================================================================
// Settlement Proposal History Messages (Append-only Event Log)
// ============================================================================

// Record a settlement event (any party can record for their settlements)
message RecordSettlementEventRequest {
  CantonNodeAuth auth = 1;
  string proposal_id = 2;  // UUID v7
  string recorded_by = 3;  // Party ID who is recording
  RecordedByRole recorded_by_role = 4;
  SettlementEventType event_type = 5;

  // Canton transaction tracking (two-phase)
  optional string submission_id = 6;  // Phase 1: received on tx submit
  optional string update_id = 7;       // Phase 2: received after ledger poll
  optional string contract_id = 8;     // Canton contract ID
  optional string template_id = 9;     // Daml template ID

  // Result
  SettlementEventResult result = 10;
  optional string error_message = 11;
  optional google.protobuf.Struct metadata = 12;

  // Alternative auth for external parties
  optional ExternalAuth external_auth = 20;
}

message RecordSettlementEventResponse {
  bool success = 1;
  string message = 2;
  uint64 event_id = 3;  // Auto-generated history entry ID
}

// Get settlement history (parties can only see their own settlements)
message GetSettlementHistoryRequest {
  CantonNodeAuth auth = 1;
  string proposal_id = 2;  // UUID v7
  optional SettlementEventType event_type = 3;  // Filter by event type
  optional SettlementEventResult result = 4;     // Filter by result
  optional uint32 limit = 5;
  optional uint32 offset = 6;
}

message GetSettlementHistoryResponse {
  repeated SettlementHistoryEntry events = 1;
  uint32 total = 2;
}

// Settlement history entry (matches settlement_proposal_history table)
message SettlementHistoryEntry {
  uint64 id = 1;
  string proposal_id = 2;
  string recorded_by = 3;
  RecordedByRole recorded_by_role = 4;
  SettlementEventType event_type = 5;

  // Canton transaction tracking
  optional string submission_id = 6;
  optional string update_id = 7;
  optional string contract_id = 8;
  optional string template_id = 9;

  // Result
  SettlementEventResult result = 10;
  optional string error_message = 11;
  optional google.protobuf.Struct metadata = 12;

  google.protobuf.Timestamp created_at = 13;
}

// Update proposal status (operator only)
message UpdateProposalStatusRequest {
  CantonNodeAuth auth = 1;
  string proposal_id = 2;  // UUID v7
  enum NewStatus {
    NEW_STATUS_UNSPECIFIED = 0;
    NEW_STATUS_SETTLED = 1;
    NEW_STATUS_CANCELLED = 2;
    NEW_STATUS_FAILED = 3;
  }
  NewStatus new_status = 3;  // Only pending → settled/cancelled/failed allowed
  optional string error_message = 4;  // Required if failed
}

message UpdateProposalStatusResponse {
  bool success = 1;
  string message = 2;
}

// ============================================================================
// Get Settlement Proposal By ID Messages
// ============================================================================

// Get settlement proposal by ID request
message GetSettlementProposalByIdRequest {
  oneof auth {
    CantonNodeAuth canton_auth = 1;
    ExternalAuth external_auth = 2;
  }
  string proposal_id = 3;  // UUID v7
}

// Get settlement proposal by ID response
message GetSettlementProposalByIdResponse {
  bool found = 1;
  SettlementProposalMessage proposal = 2;
}